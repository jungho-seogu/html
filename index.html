<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <title>ì›”ë³„ ì•„ì´í…œ ë§¤ì¶œ ì ë„í‘œ</title>
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    <script>
      const DATA_URL = 'https://script.google.com/macros/s/AKfycbyyYJWkbTbR001BFrTq5AU_qpAZ3ttN-0cn1G6V5ASfqrKCkZg1yMqLdmXcWe94S0c/exec';

      google.charts.load('current', { packages: ['corechart'] });
      google.charts.setOnLoadCallback(init);

      let data = [];

      async function init() {
        const response = await fetch(DATA_URL);
        const json = await response.json();

        data = json.data;

        const ì•„ì´í…œëª…_ëª©ë¡ = [...new Set(data.map(d => d['ì•„ì´í…œëª…']))].sort();

        const itemSelect = document.getElementById('itemSelect');
        const codeSelect = document.getElementById('codeSelect');

        ì•„ì´í…œëª…_ëª©ë¡.forEach(item => {
          const option = document.createElement('option');
          option.value = item;
          option.text = item;
          itemSelect.appendChild(option);
        });

        itemSelect.addEventListener('change', () => {
          const selectedItem = itemSelect.value;

          const filteredCodes = [...new Set(data.filter(d => d['ì•„ì´í…œëª…'] === selectedItem).map(d => d['ìƒí’ˆì½”ë“œ']))].sort();

          codeSelect.innerHTML = '<option value="">ì „ì²´</option>';
          filteredCodes.forEach(code => {
            const option = document.createElement('option');
            option.value = code;
            option.text = code;
            codeSelect.appendChild(option);
          });

          drawChart();
        });

        codeSelect.addEventListener('change', () => {
          drawChart();
        });

        drawChart();
      }

      function drawChart() {
        const itemSelect = document.getElementById('itemSelect');
        const codeSelect = document.getElementById('codeSelect');

        const selectedItem = itemSelect.value;
        const selectedCode = codeSelect.value;

        let chartData = [['ì›”', 'ì•„ì´í…œëª…', { role: 'tooltip', type: 'string' }, 'íŒë§¤ê¸ˆì•¡']];

        const filtered = data.filter(d => {
          return (!selectedItem || d['ì•„ì´í…œëª…'] === selectedItem) &&
                 (!selectedCode || d['ìƒí’ˆì½”ë“œ'] === selectedCode);
        });

        if (filtered.length === 0) {
          document.getElementById('chart_div').innerHTML = 'ğŸ“Œ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. ë‹¤ë¥¸ ì•„ì´í…œì„ ì„ íƒí•´ë³´ì„¸ìš”.';
          return;
        }

        filtered.forEach(d => {
          const íŒë§¤ê¸ˆì•¡ = d['íŒë§¤ê¸ˆì•¡'] || 0;
          chartData.push([
            Number(d['ì›”']),        // ì›”: number
            String(d['ì•„ì´í…œëª…']),   // ì•„ì´í…œëª…: string
            `ì›”: ${d['ì›”']}\nì•„ì´í…œëª…: ${d['ì•„ì´í…œëª…']}\në§¤ì¶œ: ${íŒë§¤ê¸ˆì•¡.toLocaleString()}`,
            íŒë§¤ê¸ˆì•¡
          ]);
        });

        // ğŸš¨ íƒ€ì… ì¶”ë¡  false
        const dataTable = google.visualization.arrayToDataTable(chartData, false);

        const options = {
          title: 'ì›”ë³„ ì•„ì´í…œëª… ë§¤ì¶œ ì ë„í‘œ',
          hAxis: { title: 'ì›”' },
          vAxis: { title: 'ì•„ì´í…œëª…' },
          bubble: { textStyle: { fontSize: 11 } },
          colorAxis: { colors: ['#aec7e8', '#1f77b4'] },
          tooltip: { isHtml: true }
        };

        const chart = new google.visualization.BubbleChart(document.getElementById('chart_div'));
        chart.draw(dataTable, options);
      }
    </script>
  </head>
  <body>
    <h2>ì›”ë³„ ì•„ì´í…œ ë§¤ì¶œ ì ë„í‘œ</h2>
    <div>
      <label>ì•„ì´í…œëª…: </label>
      <select id="itemSelect">
        <option value="">ì „ì²´</option>
      </select>
      <label>ìƒí’ˆì½”ë“œ: </label>
      <select id="codeSelect">
        <option value="">ì „ì²´</option>
      </select>
    </div>
    <div id="chart_div" style="width: 100%; height: 600px;"></div>
  </body>
</html>
