<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>ì›”ë³„ ì•„ì´í…œ ë§¤ì¶œ ì ë„í‘œ</title>
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
</head>
<body>
  <h2>ì›”ë³„ ì•„ì´í…œ ë§¤ì¶œ ì ë„í‘œ</h2>
  <div>
    <label>ì•„ì´í…œëª…: </label>
    <select id="itemSelect">
      <option value="">ì „ì²´</option>
    </select>
    <label>ìƒí’ˆì½”ë“œ: </label>
    <select id="codeSelect">
      <option value="">ì „ì²´</option>
    </select>
  </div>
  <div id="chart_div" style="width: 100%; height: 600px;"></div>

  <script>
    const DATA_URL = 'https://script.google.com/macros/s/AKfycbyyYJWkbTbR001BFrTq5AU_qpAZ3ttN-0cn1G6V5ASfqrKCkZg1yMqLdmXcWe94S0c/exec';
    let rawData = [];

    async function init() {
      const response = await fetch(DATA_URL);
      const json = await response.json();
      rawData = json.data.filter(d => d['ë§¤ì¶œ'] >= 0);

      const ì•„ì´í…œëª…_ëª©ë¡ = [...new Set(rawData.map(d => d['ì•„ì´í…œëª…']))].sort();
      const itemSelect = document.getElementById('itemSelect');
      const codeSelect = document.getElementById('codeSelect');

      ì•„ì´í…œëª…_ëª©ë¡.forEach(item => {
        const option = document.createElement('option');
        option.value = item;
        option.text = item;
        itemSelect.appendChild(option);
      });

      itemSelect.addEventListener('change', updateCodeSelect);
      codeSelect.addEventListener('change', drawChart);

      drawChart();
    }

    function updateCodeSelect() {
      const selectedItem = document.getElementById('itemSelect').value;
      const codeSelect = document.getElementById('codeSelect');

      let codes;
      if (selectedItem) {
        codes = [...new Set(rawData.filter(d => d['ì•„ì´í…œëª…'] === selectedItem).map(d => d['ìƒí’ˆì½”ë“œ']))];
      } else {
        codes = [...new Set(rawData.map(d => d['ìƒí’ˆì½”ë“œ']))];
      }

      codes.sort();
      codeSelect.innerHTML = '<option value="">ì „ì²´</option>';
      codes.forEach(code => {
        const option = document.createElement('option');
        option.value = code;
        option.text = code;
        codeSelect.appendChild(option);
      });

      drawChart();
    }

    function drawChart() {
      const selectedItem = document.getElementById('itemSelect').value;
      const selectedCode = document.getElementById('codeSelect').value;

      let filteredData = rawData;
      if (selectedItem) {
        filteredData = filteredData.filter(d => d['ì•„ì´í…œëª…'] === selectedItem);
      }
      if (selectedCode) {
        filteredData = filteredData.filter(d => d['ìƒí’ˆì½”ë“œ'] === selectedCode);
      }

      const ì›”ì´ë§¤ì¶œ = {};
      rawData.forEach(d => {
        if (!ì›”ì´ë§¤ì¶œ[d['ì›”']]) ì›”ì´ë§¤ì¶œ[d['ì›”']] = 0;
        ì›”ì´ë§¤ì¶œ[d['ì›”']] += d['ë§¤ì¶œ'];
      });

      const groups = {};
      filteredData.forEach(d => {
        const code = d['ìƒí’ˆì½”ë“œ'];
        if (!groups[code]) {
          groups[code] = { x: [], y: [], text: [] };
        }
        const totalSales = ì›”ì´ë§¤ì¶œ[d['ì›”']] || 1;
        let hoverText = `ì›”: ${d['ì›”']}<br>ì•„ì´í…œëª…: ${d['ì•„ì´í…œëª…']}<br>ìƒí’ˆì½”ë“œ: ${d['ìƒí’ˆì½”ë“œ']}<br>íŒë§¤ê¸ˆì•¡: ${d['ë§¤ì¶œ'].toLocaleString()}<br>ìˆ˜ëŸ‰: ${d['ìˆ˜ëŸ‰']}<br>í•´ë‹¹ ì›” ì´ë§¤ì¶œ: ${totalSales.toLocaleString()}`;

        groups[code].x.push(d['ì›”'].toString());
        groups[code].y.push(d['ë§¤ì¶œ']);
        groups[code].text.push(hoverText);
      });

      const colors = [
        'blue', 'red', 'green', 'orange', 'purple', 'brown', 'pink', 'gray', 'olive', 'cyan'
      ];

      const traces = Object.keys(groups).map((code, idx) => ({
        x: groups[code].x,
        y: groups[code].y,
        text: groups[code].text,
        mode: 'markers',
        type: 'scatter',
        name: code,
        marker: { color: colors[idx % colors.length], size: 8 }
      }));

      // ğŸ’¡ ì´ë§¤ì¶œ êº¾ì€ì„  ê·¸ë˜í”„ ì¶”ê°€
      const totalSalesTrace = {
        x: Object.keys(ì›”ì´ë§¤ì¶œ).sort(),
        y: Object.keys(ì›”ì´ë§¤ì¶œ).sort().map(ì›” => ì›”ì´ë§¤ì¶œ[ì›”]),
        mode: 'lines+markers',
        name: 'ì›”ë³„ ì´ë§¤ì¶œ',
        line: { color: 'black', width: 2, dash: 'solid' },
        marker: { size: 6 }
      };

      traces.push(totalSalesTrace); // âœ… ì  + êº¾ì€ì„  ê°™ì´ ê·¸ë¦¬ê¸°

      const layout = {
        title: 'ì›”ë³„ ë§¤ì¶œ ì ë„í‘œ + ì´ë§¤ì¶œ êº¾ì€ì„ ',
        xaxis: { title: 'ì›”', type: 'category' },
        yaxis: { title: 'íŒë§¤ê¸ˆì•¡', rangemode: 'tozero' },
        hovermode: 'closest'
      };

      Plotly.newPlot('chart_div', traces, layout);
    }

    init();
  </script>
</body>
</html>
