<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <title>월별 아이템 매출 점도표</title>
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    <script>
      const DATA_URL = 'https://script.google.com/macros/s/AKfycbyyYJWkbTbR001BFrTq5AU_qpAZ3ttN-0cn1G6V5ASfqrKCkZg1yMqLdmXcWe94S0c/exec';

      google.charts.load('current', { packages: ['corechart'] });
      google.charts.setOnLoadCallback(init);

      let data = [];

      async function init() {
        const response = await fetch(DATA_URL);
        const json = await response.json();

        data = json.data;

        const 아이템명_목록 = [...new Set(data.map(d => d['아이템명']))].sort();

        const itemSelect = document.getElementById('itemSelect');
        const codeSelect = document.getElementById('codeSelect');

        아이템명_목록.forEach(item => {
          const option = document.createElement('option');
          option.value = item;
          option.text = item;
          itemSelect.appendChild(option);
        });

        itemSelect.addEventListener('change', updateCodeOptions);
        codeSelect.addEventListener('change', drawChart);

        drawChart();
      }

      function updateCodeOptions() {
        const itemSelect = document.getElementById('itemSelect');
        const codeSelect = document.getElementById('codeSelect');
        const selectedItem = itemSelect.value;

        const filteredCodes = [...new Set(data.filter(d => d['아이템명'] === selectedItem).map(d => d['상품코드']))].sort();

        codeSelect.innerHTML = '<option value="">전체</option>';
        filteredCodes.forEach(code => {
          const option = document.createElement('option');
          option.value = code;
          option.text = code;
          codeSelect.appendChild(option);
        });

        drawChart();
      }

      function drawChart() {
        const itemSelect = document.getElementById('itemSelect');
        const codeSelect = document.getElementById('codeSelect');

        const selectedItem = itemSelect.value;
        const selectedCode = codeSelect.value;

        // X: 월 (숫자), Y: 아이템명 (카테고리 인덱스)
        let chartData = [['월', '아이템명 인덱스', {type: 'string', role: 'tooltip'}]];

        // 아이템명 -> 인덱스 맵핑
        const uniqueItems = [...new Set(data.map(d => d['아이템명']))];
        const itemIndexMap = {};
        uniqueItems.forEach((item, index) => {
          itemIndexMap[item] = index + 1;  // 1부터 시작
        });

        const filtered = data.filter(d => {
          return (!selectedItem || d['아이템명'] === selectedItem) &&
                 (!selectedCode || d['상품코드'] === selectedCode);
        });

        if (filtered.length === 0) {
          document.getElementById('chart_div').innerHTML = '📌 데이터가 없습니다. 다른 아이템을 선택해보세요.';
          return;
        }

        filtered.forEach(d => {
          const 판매금액 = d['매출'] || 0;
          chartData.push([
            Number(d['월']),
            itemIndexMap[d['아이템명']],
            `월: ${d['월']}\n아이템명: ${d['아이템명']}\n매출: ${판매금액.toLocaleString()}`
          ]);
        });

        const dataTable = google.visualization.arrayToDataTable(chartData);

        const options = {
          title: '월별 아이템 매출 점도표',
          hAxis: { title: '월', format: '####' },
          vAxis: {
            title: '아이템명',
            ticks: uniqueItems.map((item, index) => ({v: index + 1, f: item})) // y축을 아이템명으로 매핑
          },
          legend: 'none',
          tooltip: { isHtml: true }
        };

        const chart = new google.visualization.ScatterChart(document.getElementById('chart_div'));
        chart.draw(dataTable, options);
      }
    </script>
  </head>
  <body>
    <h2>월별 아이템 매출 점도표</h2>
    <div>
      <label>아이템명: </label>
      <select id="itemSelect">
        <option value="">전체</option>
      </select>
      <label>상품코드: </label>
      <select id="codeSelect">
        <option value="">전체</option>
      </select>
    </div>
    <div id="chart_div" style="width: 100%; height: 600px;"></div>
  </body>
</html>
