<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <title>ì›”ë³„ ë§¤ì¶œ ì ë„í‘œ</title>
    <script src="https://cdn.plot.ly/plotly-2.24.1.min.js"></script>
    <style>
      select { margin-right: 10px; }
    </style>
  </head>
  <body>
    <h2>ì›”ë³„ ì•„ì´í…œ ë§¤ì¶œ ì ë„í‘œ</h2>
    <div>
      <label>ì•„ì´í…œëª…: </label>
      <select id="itemSelect">
        <option value="">ì „ì²´</option>
      </select>
      <label>ìƒí’ˆì½”ë“œ: </label>
      <select id="codeSelect">
        <option value="">ì „ì²´</option>
      </select>
    </div>
    <div id="chart" style="width: 100%; height: 600px;"></div>

    <script>
      const DATA_URL = 'https://script.google.com/macros/s/AKfycbyyYJWkbTbR001BFrTq5AU_qpAZ3ttN-0cn1G6V5ASfqrKCkZg1yMqLdmXcWe94S0c/exec';
      let data = [];

      async function init() {
        const res = await fetch(DATA_URL);
        const json = await res.json();
        data = json.data.filter(d => d['ë§¤ì¶œ'] >= 0); // ğŸ”¥ ìŒìˆ˜ ë§¤ì¶œ ì œì™¸

        const itemSelect = document.getElementById('itemSelect');
        const codeSelect = document.getElementById('codeSelect');

        const ì•„ì´í…œë“¤ = [...new Set(data.map(d => d['ì•„ì´í…œëª…']))].sort();
        ì•„ì´í…œë“¤.forEach(item => {
          const opt = document.createElement('option');
          opt.value = item;
          opt.text = item;
          itemSelect.appendChild(opt);
        });

        itemSelect.addEventListener('change', () => {
          const selectedItem = itemSelect.value;
          const ê´€ë ¨ìƒí’ˆì½”ë“œ = [...new Set(data.filter(d => d['ì•„ì´í…œëª…'] === selectedItem).map(d => d['ìƒí’ˆì½”ë“œ']))].sort();
          codeSelect.innerHTML = '<option value="">ì „ì²´</option>';
          ê´€ë ¨ìƒí’ˆì½”ë“œ.forEach(code => {
            const opt = document.createElement('option');
            opt.value = code;
            opt.text = code;
            codeSelect.appendChild(opt);
          });
          drawChart();
        });

        codeSelect.addEventListener('change', drawChart);
        drawChart();
      }

      function drawChart() {
        const item = document.getElementById('itemSelect').value;
        const code = document.getElementById('codeSelect').value;

        const filtered = data.filter(d =>
          (!item || d['ì•„ì´í…œëª…'] === item) &&
          (!code || d['ìƒí’ˆì½”ë“œ'] === code)
        );

        const ì›”ì´ë§¤ì¶œ = {};
        data.forEach(d => {
          const ì›” = d['ì›”'];
          ì›”ì´ë§¤ì¶œ[ì›”] = (ì›”ì´ë§¤ì¶œ[ì›”] || 0) + d['ë§¤ì¶œ'];
        });

        const ìƒ‰ìƒ = {};
        const ìƒ‰ìƒë¦¬ìŠ¤íŠ¸ = [
          '#1f77b4', '#ff7f0e', '#2ca02c', '#d62728', '#9467bd',
          '#8c564b', '#e377c2', '#7f7f7f', '#bcbd22', '#17becf'
        ];
        let ìƒ‰ìƒì¸ë±ìŠ¤ = 0;

        const traceMap = {};

        filtered.forEach(d => {
          const key = d['ìƒí’ˆì½”ë“œ'] || d['ì•„ì´í…œëª…'];
          if (!traceMap[key]) {
            const color = ìƒ‰ìƒë¦¬ìŠ¤íŠ¸[ìƒ‰ìƒì¸ë±ìŠ¤++ % ìƒ‰ìƒë¦¬ìŠ¤íŠ¸.length];
            traceMap[key] = {
              x: [],
              y: [],
              text: [],
              mode: 'markers',
              type: 'scatter',
              name: key,
              marker: { size: 8, color }
            };
          }

          const ì›” = d['ì›”'];
          const ë§¤ì¶œ = d['ë§¤ì¶œ'];
          const ìˆ˜ëŸ‰ = d['ìˆ˜ëŸ‰'];
          const ì „ì²´ = ì›”ì´ë§¤ì¶œ[ì›”];
          const ë¹„ìœ¨ = ì „ì²´ ? (ë§¤ì¶œ / ì „ì²´ * 100).toFixed(1) + '%' : '';

          const tip = `ì›”: ${ì›”}<br>ì•„ì´í…œëª…: ${d['ì•„ì´í…œëª…']}<br>ìƒí’ˆì½”ë“œ: ${d['ìƒí’ˆì½”ë“œ']}<br>íŒë§¤ê¸ˆì•¡: ${ë§¤ì¶œ.toLocaleString()}<br>ìˆ˜ëŸ‰: ${ìˆ˜ëŸ‰}` +
                      (code ? `<br>ì „ì²´ ëŒ€ë¹„: ${ë¹„ìœ¨}` : '');

          traceMap[key].x.push(ì›”);
          traceMap[key].y.push(ë§¤ì¶œ);
          traceMap[key].text.push(tip);
        });

        const dotTraces = Object.values(traceMap);

        const sortedMonths = Object.keys(ì›”ì´ë§¤ì¶œ).map(Number).sort((a, b) => a - b);
        const totalTrace = {
          x: sortedMonths,
          y: sortedMonths.map(m => ì›”ì´ë§¤ì¶œ[m]),
          mode: 'lines+markers',
          type: 'scatter',
          name: 'ì›” ì´ë§¤ì¶œ',
          line: { color: 'black', width: 2 },
          marker: { size: 4 }
        };

        Plotly.newPlot('chart', [...dotTraces, totalTrace], {
          title: 'ì›”ë³„ ë§¤ì¶œ ì ë„í‘œ',
          xaxis: { title: 'ì›”', tickformat: 'd' },
          yaxis: { title: 'íŒë§¤ê¸ˆì•¡' },
          hovermode: 'closest'
        });
      }

      init();
    </script>
  </body>
</html>
